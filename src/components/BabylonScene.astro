<canvas id="renderCanvas"></canvas>
<script>
import { Engine } from "@babylonjs/core/Engines/engine";
import { Scene } from "@babylonjs/core/scene";
import { UniversalCamera } from "@babylonjs/core/Cameras/universalCamera";
import { Vector3 } from "@babylonjs/core/Maths/math.vector";
import { Color4 } from "@babylonjs/core/Maths/math.color";
import { ImportMeshAsync } from "@babylonjs/core/Loading/sceneLoader";   
import "@babylonjs/loaders/SPLAT/splatFileLoader";

const canvas = document.getElementById("renderCanvas") as HTMLCanvasElement;
const engine = new Engine(canvas, true, {
	antialias: false, 
	powerPreference: "high-performance",
	preserveDrawingBuffer: false,
	stencil: false
});

const createScene = async () => {
	const scene = new Scene(engine);
	scene.clearColor = new Color4(0.2, 0.15, 0.1, 1);
	
	// Optimize scene rendering
	scene.skipPointerMovePicking = true;
	scene.autoClear = false;
	scene.autoClearDepthAndStencil = false;
	
	const camera = new UniversalCamera("camera", new Vector3(7.15, 1.75, 8.94), scene);
	camera.minZ = 0.1;
	camera.maxZ = 200; 
	camera.rotation.y = Math.PI * 3.2;
	camera.speed = 0.3;
	
	// Configure mouse wheel with better precision
	camera.inputs.addMouseWheel();
	camera.inputs.attached.mousewheel.wheelPrecisionX = 0.2;
	camera.inputs.attached.mousewheel.wheelPrecisionY = 0.2;
	camera.inputs.attached.mousewheel.wheelPrecisionZ = 0.2;
	
	// Add and configure touch controls with increased speed
	camera.inputs.addTouch();
	camera.inputs.attached.touch.touchAngularSensibility = 10000; // Lower = faster (default: 200000)
	//camera.inputs.attached.touch.touchMoveSensibility = 100; // Lower = faster (default: 250)
	
	camera.attachControl(canvas, true);
	
	// Load Gaussian Splatting mesh
	const result = await ImportMeshAsync("/sog/scene5_500k.sog", scene);
	const gaussianSplattingMesh = result.meshes[0];
	gaussianSplattingMesh.position.y = -2;
	
	// Freeze mesh to optimize performance (if it doesn't need to move)
	gaussianSplattingMesh.freezeWorldMatrix();
	
	return scene;
};

const main = async () => {
	const scene = await createScene();
	
	// Optimize render loop
	engine.runRenderLoop(() => {
		scene.render();
	});
};

// Handle cleanup on page unload
const cleanup = () => {
	engine.stopRenderLoop();
	engine.dispose();
};

// Handle resize with debouncing for better performance
let resizeTimeout: number;
const handleResize = () => {
	clearTimeout(resizeTimeout);
	resizeTimeout = setTimeout(() => {
		engine.resize();
	}, 100);
};

window.addEventListener("resize", handleResize);
window.addEventListener("beforeunload", cleanup);

main().catch(err => {
	console.error("Failed to initialize scene:", err);
});
</script>

<style>
#renderCanvas {
	width: 100%;
	height: 100%;
	display: block;
	touch-action: none; /* Prevents default touch behaviors */
	outline: none;
}
</style>
